<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tool Editor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .header {
      background: #2a2a2a;
      padding: 12px 16px;
      border-bottom: 1px solid #3a3a3a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .title { font-weight: bold; color: #4ade80; font-size: 16px; }
    .toolbar {
      display: flex;
      gap: 8px;
    }
    .toolbar button {
      background: #3a3a3a;
      border: none;
      color: #e0e0e0;
      padding: 6px 14px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }
    .toolbar button:hover { background: #4a4a4a; }
    .toolbar button.primary {
      background: #4ade80;
      color: #1a1a1a;
    }
    .toolbar button.primary:hover { background: #22c55e; }
    .toolbar button:disabled {
      background: #2a2a2a;
      color: #666;
      cursor: not-allowed;
    }
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .sidebar {
      width: 260px;
      background: #242424;
      border-right: 1px solid #3a3a3a;
      overflow-y: auto;
      padding: 16px;
    }
    .sidebar h3 {
      color: #4ade80;
      margin-bottom: 12px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .tool-list {
      list-style: none;
    }
    .tool-item {
      background: #2a2a2a;
      padding: 10px 12px;
      margin: 6px 0;
      border-radius: 6px;
      cursor: pointer;
      border-left: 3px solid transparent;
    }
    .tool-item:hover {
      background: #333;
      border-left-color: #4ade80;
    }
    .tool-item.active {
      background: #3a3a3a;
      border-left-color: #4ade80;
    }
    .tool-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .tool-desc { font-size: 11px; color: #999; }
    .editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .tabs {
      display: flex;
      background: #252525;
      border-bottom: 1px solid #3a3a3a;
      padding: 0 12px;
    }
    .tab {
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-size: 13px;
    }
    .tab:hover { background: #2a2a2a; }
    .tab.active {
      border-bottom-color: #4ade80;
      color: #4ade80;
    }
    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      color: #ccc;
      font-weight: 600;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      color: #e0e0e0;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 14px;
    }
    .form-group textarea {
      font-family: 'Courier New', monospace;
      min-height: 120px;
      resize: vertical;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #4ade80;
    }
    .param-list {
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 8px;
      padding: 16px;
    }
    .param-item {
      background: #1e1e1e;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .param-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .param-header h4 {
      color: #4ade80;
      font-size: 14px;
    }
    .param-header button {
      background: #ff5f56;
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .param-field {
      margin-bottom: 12px;
    }
    .param-field label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
      color: #999;
    }
    .param-field input, .param-field select {
      width: 100%;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      color: #e0e0e0;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 13px;
    }
    .add-param-btn {
      background: #4ade80;
      border: none;
      color: #1a1a1a;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      width: 100%;
    }
    .add-param-btn:hover { background: #22c55e; }
    .test-panel {
      background: #242424;
      border-top: 1px solid #3a3a3a;
      padding: 20px;
    }
    .test-panel h3 {
      color: #4ade80;
      margin-bottom: 16px;
      font-size: 14px;
    }
    .test-result {
      background: #1e1e1e;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 200px;
      overflow-y: auto;
    }
    .test-result.success { border-color: #4ade80; color: #4ade80; }
    .test-result.error { border-color: #ff5f56; color: #ff5f56; }
    .schema-preview {
      background: #1e1e1e;
      border: 1px solid #3a3a3a;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
    }
    .code-block {
      background: #1e1e1e;
      border: 1px solid #3a3a3a;
      border-radius: 8px;
      padding: 16px;
      margin-top: 12px;
    }
    .code-block pre {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      color: #e0e0e0;
      overflow-x: auto;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 8px;
      padding: 16px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 400px;
      animation: slideIn 0.3s ease;
    }
    .notification.success { border-left: 4px solid #4ade80; }
    .notification.error { border-left: 4px solid #ff5f56; }
    .notification.info { border-left: 4px solid #4a9eff; }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">ðŸ”§ Tool Editor</div>
    <div class="toolbar">
      <button onclick="newTool()">New Tool</button>
      <button onclick="saveTool()" class="primary" id="saveBtn">Save</button>
      <button onclick="deleteTool()" id="deleteBtn">Delete</button>
      <button onclick="exportTool()">Export</button>
      <button onclick="generateDocs()">Generate Docs</button>
    </div>
  </div>
  <div class="main">
    <div class="sidebar">
      <h3>Tools</h3>
      <ul class="tool-list" id="toolList">
        <div class="empty-state">
          <div class="empty-state-icon">ðŸ”§</div>
          <div>Loading tools...</div>
        </div>
      </ul>
    </div>
    <div class="editor-container">
      <div class="tabs">
        <div class="tab active" onclick="switchTab('definition')">Definition</div>
        <div class="tab" onclick="switchTab('imports')">Imports</div>
        <div class="tab" onclick="switchTab('parameters')">Parameters</div>
        <div class="tab" onclick="switchTab('test')">Test</div>
        <div class="tab" onclick="switchTab('schema')">Schema</div>
      </div>
      <div class="content" id="definitionTab">
        <div class="form-group">
          <label>Tool Name</label>
          <input type="text" id="toolName" placeholder="my-tool" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="toolDesc" placeholder="Describe what this tool does"></textarea>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="toolCategory">
            <option value="data">Data</option>
            <option value="api">API</option>
            <option value="file">File System</option>
            <option value="util">Utility</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="form-group">
          <label>Implementation</label>
          <textarea id="toolImpl" style="min-height: 200px;" placeholder="async function executeTool(params) {
  // Tool implementation
  return { success: true };
}"></textarea>
        </div>
      </div>
      <div class="content" id="importsTab" style="display: none;">
        <h3 style="color: #4ade80; margin-bottom: 16px;">Imports & Dependencies</h3>

        <div class="form-group">
          <label>NPM Packages</label>
          <p style="font-size: 12px; color: #999; margin-bottom: 8px;">Comma-separated list of npm packages (e.g., axios, lodash, moment)</p>
          <textarea id="npmPackages" style="min-height: 80px;" placeholder="axios, lodash, moment"></textarea>
        </div>

        <div class="form-group">
          <label>CDN URLs</label>
          <p style="font-size: 12px; color: #999; margin-bottom: 8px;">External library URLs (one per line)</p>
          <textarea id="cdnUrls" style="min-height: 100px;" placeholder="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js
https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></textarea>
        </div>

        <div class="form-group">
          <label>ES Module Imports</label>
          <p style="font-size: 12px; color: #999; margin-bottom: 8px;">Import statements for your tool implementation</p>
          <textarea id="esImports" style="min-height: 120px;" placeholder="import axios from 'axios';
import { debounce } from 'lodash';
import moment from 'moment';"></textarea>
        </div>

        <div class="form-group">
          <label>Import Map (Advanced)</label>
          <p style="font-size: 12px; color: #999; margin-bottom: 8px;">Custom import map for module resolution</p>
          <textarea id="importMap" style="min-height: 150px;" placeholder='{
  "imports": {
    "axios": "https://cdn.jsdelivr.net/npm/axios@1.6.0/+esm",
    "lodash": "https://cdn.jsdelivr.net/npm/lodash@4.17.21/+esm"
  }
}'></textarea>
        </div>

        <div class="code-block">
          <h4 style="color: #4ade80; margin-bottom: 12px;">Generated Import Configuration</h4>
          <pre id="importPreview">Configure imports above to see preview</pre>
        </div>
      </div>
      <div class="content" id="parametersTab" style="display: none;">
        <h3 style="color: #4ade80; margin-bottom: 16px;">Parameters</h3>
        <div class="param-list" id="paramList">
        </div>
        <button class="add-param-btn" onclick="addParameter()">+ Add Parameter</button>
      </div>
      <div class="content" id="testTab" style="display: none;">
        <div class="test-panel">
          <h3>Test Input</h3>
          <div class="form-group">
            <label>Parameters (JSON)</label>
            <textarea id="testInput" style="min-height: 150px;" placeholder='{
  "operation": "query",
  "query": "SELECT * FROM users WHERE id = 1"
}'></textarea>
          </div>
          <button class="primary" style="width: 100%; padding: 12px;" onclick="runTest()">â–¶ Run Test</button>
          <h3 style="margin-top: 24px;">Test Result</h3>
          <div class="test-result" id="testResult">
            Click "Run Test" to execute the tool with test input
          </div>
        </div>
      </div>
      <div class="content" id="schemaTab" style="display: none;">
        <h3 style="color: #4ade80; margin-bottom: 16px;">JSON Schema</h3>
        <p style="color: #999; margin-bottom: 16px; font-size: 13px;">
          Auto-generated schema based on your parameter definitions
        </p>
        <div class="schema-preview" id="schemaPreview">
          <pre>Define parameters to see schema</pre>
        </div>
        <h3 style="color: #4ade80; margin: 24px 0 16px;">Usage Example</h3>
        <div class="code-block">
          <pre id="usageExample">// Call the tool in your task
const result = await __callHostTool__('my-tool', {
  // parameters here
});

console.log('Result:', result);</pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    // [Storage-Manager-Injected]

function createStorageManager(appId) {
  const stateKey = `app-state:${appId}`;
  const expiryKey = `app-state-expiry:${appId}`;
  return {
    save(state, ttlMs = null) {
      try {
        localStorage.setItem(stateKey, JSON.stringify(state));
        if (ttlMs) {
          const expiryTime = Date.now() + ttlMs;
          localStorage.setItem(expiryKey, expiryTime.toString());
        }
      } catch (error) {
        console.error(`[Storage] Failed to save state for ${appId}:`, error);
      }
    },
    load() {
      try {
        const expiryTime = localStorage.getItem(expiryKey);
        if (expiryTime && Date.now() > parseInt(expiryTime)) {
          this.clear();
          return null;
        }
        const stateStr = localStorage.getItem(stateKey);
        return stateStr ? JSON.parse(stateStr) : null;
      } catch (error) {
        console.error(`[Storage] Failed to load state for ${appId}:`, error);
        return null;
      }
    },
    clear() {
      try {
        localStorage.removeItem(stateKey);
        localStorage.removeItem(expiryKey);
      } catch (error) {
        console.error(`[Storage] Failed to clear state for ${appId}:`, error);
      }
    }
  };
}

    const storage = createStorageManager('app-tool-editor');
    const savedState = storage.load();
    if (savedState) {
      selectedTool = savedState.selectedTool || selectedTool;
      editingTool = savedState.editingTool || editingTool;
    }
    window.addEventListener('beforeunload', () => {
      storage.save({ selectedTool, editingTool });
    });
  

    let currentTool = null;
    let tools = [];
    let parameters = [];

    function showNotification(message, type = 'info') {
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();

      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    async function loadTools() {
      try {
        const res = await fetch('/api/tools');
        if (!res.ok) {
          showNotification('Failed to load tools', 'error');
          return;
        }
        tools = await res.json();
        renderToolList();

        if (tools.length > 0) {
          selectToolById(tools[0].id);
        }
      } catch (error) {
        console.error('Failed to load tools:', error);
        showNotification('Error loading tools: ' + error.message, 'error');
        renderEmptyState();
      }
    }

    function renderToolList() {
      const list = document.getElementById('toolList');
      if (tools.length === 0) {
        renderEmptyState();
        return;
      }

      list.innerHTML = tools.map((tool, idx) => `
        <li class="tool-item ${idx === 0 ? 'active' : ''}" onclick="selectToolById('${tool.id}')" data-tool-id="${tool.id}">
          <div class="tool-name">${tool.name || tool.id}</div>
          <div class="tool-desc">${tool.description || 'No description'}</div>
        </li>
      `).join('');
    }

    function renderEmptyState() {
      const list = document.getElementById('toolList');
      list.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ðŸ”§</div>
          <div>No tools yet</div>
          <div style="font-size: 12px; margin-top: 8px;">Click "New Tool" to create one</div>
        </div>
      `;
    }

    function selectToolById(toolId) {
      const tool = tools.find(t => t.id === toolId);
      if (!tool) return;

      currentTool = tool;

      document.querySelectorAll('.tool-item').forEach(t => t.classList.remove('active'));
      const item = document.querySelector(`[data-tool-id="${toolId}"]`);
      if (item) item.classList.add('active');

      document.getElementById('toolName').value = tool.name || '';
      document.getElementById('toolDesc').value = tool.description || '';
      document.getElementById('toolCategory').value = tool.category || 'custom';
      document.getElementById('toolImpl').value = tool.implementation || '';
      document.getElementById('npmPackages').value = (tool.imports?.npm || []).join(', ');
      document.getElementById('cdnUrls').value = (tool.imports?.cdn || []).join('\n');
      document.getElementById('esImports').value = tool.imports?.esModules || '';
      document.getElementById('importMap').value = tool.imports?.importMap ? JSON.stringify(tool.imports.importMap, null, 2) : '';

      parameters = tool.parameters || [];
      renderParameters();
      updateSchema();
      updateImportPreview();
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      document.getElementById('definitionTab').style.display = tab === 'definition' ? 'block' : 'none';
      document.getElementById('importsTab').style.display = tab === 'imports' ? 'block' : 'none';
      document.getElementById('parametersTab').style.display = tab === 'parameters' ? 'block' : 'none';
      document.getElementById('testTab').style.display = tab === 'test' ? 'block' : 'none';
      document.getElementById('schemaTab').style.display = tab === 'schema' ? 'block' : 'none';

      if (tab === 'schema') {
        updateSchema();
      }
      if (tab === 'imports') {
        updateImportPreview();
      }
    }

    function renderParameters() {
      const list = document.getElementById('paramList');
      if (parameters.length === 0) {
        list.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No parameters defined</div>';
        return;
      }

      list.innerHTML = parameters.map((param, idx) => `
        <div class="param-item">
          <div class="param-header">
            <h4>${param.name}</h4>
            <button onclick="removeParameter(${idx})">Remove</button>
          </div>
          <div class="param-field">
            <label>Name</label>
            <input type="text" value="${param.name}" onchange="updateParameter(${idx}, 'name', this.value)" />
          </div>
          <div class="param-field">
            <label>Type</label>
            <select onchange="updateParameter(${idx}, 'type', this.value)">
              <option ${param.type === 'string' ? 'selected' : ''}>string</option>
              <option ${param.type === 'number' ? 'selected' : ''}>number</option>
              <option ${param.type === 'boolean' ? 'selected' : ''}>boolean</option>
              <option ${param.type === 'object' ? 'selected' : ''}>object</option>
              <option ${param.type === 'array' ? 'selected' : ''}>array</option>
            </select>
          </div>
          <div class="param-field">
            <label>Description</label>
            <input type="text" value="${param.description || ''}" onchange="updateParameter(${idx}, 'description', this.value)" />
          </div>
          <div class="param-field">
            <label>Required</label>
            <select onchange="updateParameter(${idx}, 'required', this.value === 'Yes')">
              <option ${param.required ? 'selected' : ''}>Yes</option>
              <option ${!param.required ? 'selected' : ''}>No</option>
            </select>
          </div>
          <div class="param-field">
            <label>Default Value</label>
            <input type="text" value="${param.default || ''}" onchange="updateParameter(${idx}, 'default', this.value)" placeholder="Leave empty for none" />
          </div>
        </div>
      `).join('');
    }

    function addParameter() {
      parameters.push({
        name: 'newParam',
        type: 'string',
        description: '',
        required: false,
        default: ''
      });
      renderParameters();
      updateSchema();
    }

    function removeParameter(idx) {
      parameters.splice(idx, 1);
      renderParameters();
      updateSchema();
    }

    function updateParameter(idx, field, value) {
      if (parameters[idx]) {
        parameters[idx][field] = value;
        updateSchema();
      }
    }

    function updateSchema() {
      const schema = {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "type": "object",
        "properties": {},
        "required": []
      };

      parameters.forEach(param => {
        schema.properties[param.name] = {
          type: param.type,
          description: param.description || ''
        };
        if (param.default) {
          schema.properties[param.name].default = param.default;
        }
        if (param.required) {
          schema.required.push(param.name);
        }
      });

      document.getElementById('schemaPreview').innerHTML = `<pre>${JSON.stringify(schema, null, 2)}</pre>`;

      const toolName = document.getElementById('toolName').value || 'my-tool';
      const exampleParams = parameters.reduce((acc, param) => {
        acc[param.name] = param.default || (param.type === 'string' ? 'value' : param.type === 'number' ? 0 : null);
        return acc;
      }, {});

      document.getElementById('usageExample').textContent = `// Call the tool in your task
const result = await __callHostTool__('${toolName}', ${JSON.stringify(exampleParams, null, 2)});

console.log('Result:', result);`;
    }

    function updateImportPreview() {
      const npmText = document.getElementById('npmPackages').value;
      const cdnText = document.getElementById('cdnUrls').value;
      const esImports = document.getElementById('esImports').value;
      const importMapText = document.getElementById('importMap').value;

      const config = {
        npm: npmText ? npmText.split(',').map(s => s.trim()).filter(Boolean) : [],
        cdn: cdnText ? cdnText.split('\n').map(s => s.trim()).filter(Boolean) : [],
        esModules: esImports,
        importMap: null
      };

      try {
        if (importMapText) {
          config.importMap = JSON.parse(importMapText);
        }
      } catch (e) {
        console.error('Invalid import map JSON:', e);
      }

      document.getElementById('importPreview').textContent = JSON.stringify(config, null, 2);
    }

    async function saveTool() {
      const name = document.getElementById('toolName').value.trim();
      if (!name) {
        showNotification('Tool name is required', 'error');
        return;
      }

      const npmText = document.getElementById('npmPackages').value;
      const cdnText = document.getElementById('cdnUrls').value;
      const esImports = document.getElementById('esImports').value;
      const importMapText = document.getElementById('importMap').value;

      let importMap = null;
      try {
        if (importMapText) {
          importMap = JSON.parse(importMapText);
        }
      } catch (e) {
        showNotification('Invalid import map JSON', 'error');
        return;
      }

      const definition = {
        description: document.getElementById('toolDesc').value,
        category: document.getElementById('toolCategory').value,
        implementation: document.getElementById('toolImpl').value,
        parameters: parameters,
        imports: {
          npm: npmText ? npmText.split(',').map(s => s.trim()).filter(Boolean) : [],
          cdn: cdnText ? cdnText.split('\n').map(s => s.trim()).filter(Boolean) : [],
          esModules: esImports,
          importMap: importMap
        }
      };

      try {
        const res = await fetch('/api/tools', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, definition })
        });

        if (!res.ok) {
          const error = await res.json();
          showNotification('Failed to save: ' + (error.error || 'Unknown error'), 'error');
          return;
        }

        const saved = await res.json();
        showNotification('Tool saved successfully', 'success');

        const existingIdx = tools.findIndex(t => t.id === saved.id);
        if (existingIdx >= 0) {
          tools[existingIdx] = saved;
        } else {
          tools.push(saved);
        }

        renderToolList();
        selectToolById(saved.id);
      } catch (error) {
        console.error('Save error:', error);
        showNotification('Error saving tool: ' + error.message, 'error');
      }
    }

    async function deleteTool() {
      const name = document.getElementById('toolName').value.trim();
      if (!name) {
        showNotification('No tool selected to delete', 'error');
        return;
      }

      if (!confirm(`Delete tool "${name}"? This cannot be undone.`)) {
        return;
      }

      try {
        const res = await fetch(`/api/tools/${name}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          const error = await res.json();
          showNotification('Failed to delete: ' + (error.error || 'Unknown error'), 'error');
          return;
        }

        showNotification('Tool deleted successfully', 'success');
        tools = tools.filter(t => t.id !== name);
        renderToolList();
        currentTool = { name: '', description: '', category: '', implementation: '', parameters: [] };
        renderTool(currentTool);
      } catch (error) {
        console.error('Delete error:', error);
        showNotification('Error deleting tool: ' + error.message, 'error');
      }
    }

    function exportTool() {
      const name = document.getElementById('toolName').value || 'unnamed-tool';
      const tool = {
        name,
        description: document.getElementById('toolDesc').value,
        category: document.getElementById('toolCategory').value,
        implementation: document.getElementById('toolImpl').value,
        parameters: parameters
      };

      const json = JSON.stringify(tool, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name}-tool.json`;
      a.click();
      URL.revokeObjectURL(url);

      showNotification('Tool exported', 'success');
    }

    function generateDocs() {
      const name = document.getElementById('toolName').value || 'unnamed-tool';
      const desc = document.getElementById('toolDesc').value || 'No description';

      let paramDocs = '';
      if (parameters.length > 0) {
        paramDocs = '\n## Parameters\n\n' + parameters.map(p =>
          `- **${p.name}** (${p.type}${p.required ? ', required' : ', optional'}): ${p.description || 'No description'}`
        ).join('\n');
      }

      const exampleParams = parameters.reduce((acc, param) => {
        acc[param.name] = param.default || (param.type === 'string' ? 'value' : param.type === 'number' ? 0 : null);
        return acc;
      }, {});

      const docs = `# ${name} Tool

${desc}
${paramDocs}

## Usage

\`\`\`javascript
const result = await __callHostTool__('${name}', ${JSON.stringify(exampleParams, null, 2)});
console.log('Result:', result);
\`\`\`

## Implementation

\`\`\`javascript
${document.getElementById('toolImpl').value}
\`\`\`
`;

      const blob = new Blob([docs], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name}-README.md`;
      a.click();
      URL.revokeObjectURL(url);

      showNotification('Documentation generated', 'success');
    }

    function newTool() {
      currentTool = null;
      document.getElementById('toolName').value = 'new-tool';
      document.getElementById('toolDesc').value = '';
      document.getElementById('toolCategory').value = 'custom';
      document.getElementById('toolImpl').value = 'async function executeTool(params) {\n  // Implementation\n  return { success: true };\n}';
      document.getElementById('npmPackages').value = '';
      document.getElementById('cdnUrls').value = '';
      document.getElementById('esImports').value = '';
      document.getElementById('importMap').value = '';

      parameters = [];
      renderParameters();
      updateSchema();
      updateImportPreview();

      document.querySelectorAll('.tool-item').forEach(t => t.classList.remove('active'));
      showNotification('New tool created', 'info');
    }

    function runTest() {
      const result = document.getElementById('testResult');
      result.className = 'test-result';
      result.textContent = 'Executing tool...';

      setTimeout(() => {
        try {
          const input = JSON.parse(document.getElementById('testInput').value);
          result.className = 'test-result success';
          result.textContent = `âœ“ Success\n\nTest validation passed. Input is valid JSON.\n\nNote: Actual execution requires backend integration.`;
        } catch (error) {
          result.className = 'test-result error';
          result.textContent = `âœ— Error: ${error.message}`;
        }
      }, 500);
    }

    loadTools();
  </script>
</body>
</html>
